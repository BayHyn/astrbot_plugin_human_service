
<div align="center">

![:name](https://count.getloli.com/@astrbot_plugin_human_service?name=astrbot_plugin_human_service&theme=minecraft&padding=6&offset=0&align=top&scale=1&pixelated=1&darkmode=auto)

# astrbot_plugin_human_service

_✨ [astrbot](https://github.com/AstrBotDevs/AstrBot) 人工客服插件 ✨_  

[![License](https://img.shields.io/badge/License-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![Python 3.10+](https://img.shields.io/badge/Python-3.10%2B-blue.svg)](https://www.python.org/)
[![AstrBot](https://img.shields.io/badge/AstrBot-4.3.3-orange.svg)](https://github.com/Soulter/AstrBot)
[![GitHub](https://img.shields.io/badge/作者-Zhalslar-blue)](https://github.com/Zhalslar)

</div>

## 🤝 介绍

让bot转人工\转人机，管理员接入对话\结束对话

## ✨ 新功能特性（v1.6.0）

### 👤 客服名称显示
- **客服名称配置**：可以为每个客服配置名称，用户可以看到客服的名字
- **友好的显示**：在客服选择列表、接入提示、聊天记录等地方显示客服名称
- **向后兼容**：支持旧的配置方式（QQ号列表），无需修改现有配置

### ⏰ 时间管理系统（v1.5.0）
- **对话时间限制**：可配置单次对话的最大时长（秒），超时自动结束对话
- **排队时间限制**：可配置用户最大排队等待时长（秒），超时自动移出队列
- **超时提前提醒**：在对话即将超时前自动提醒用户和客服
- **自动接入下一位**：对话超时后自动从队列接入下一位用户
- **灵活配置**：所有时间限制都是可选的，设置为0表示不限制

### 🎯 智能队列系统（v1.4.0）
- **防止客服同时服务多人**：客服同一时间只能服务一个用户，保证服务质量
- **自动排队管理**：当客服忙碌时，用户自动加入排队队列
- **实时状态显示**：客服选择界面显示客服状态（空闲🟢/忙碌🔴）和排队人数
- **自动接入下一位**：客服结束对话后，系统自动准备接入队列中的下一位用户
- **队列查询**：用户可随时查看自己的排队位置
- **灵活退出**：用户可以随时取消排队，不影响其他用户

## 📦 安装（此为魔改源码，且并没有并入主分支，此安装方式无效）

- 可以直接在astrbot的插件市场搜索astrbot_plugin_human_service，点击安装，耐心等待安装完成即可
- 若是安装失败，可以尝试直接克隆源码：

```bash
# 克隆仓库到插件目录
cd /AstrBot/data/plugins
git clone https://github.com/Zhalslar/astrbot_plugin_human_service

# 控制台重启AstrBot
```

## ⌨️ 使用说明

### 命令表

|     命令      |                    说明                    |      使用者      |
|:-------------:|:---------------------------------------------:|:----------------:|
| `/转人工`     | 用户请求转人工。如果配置了多个客服且启用了客服选择功能，会显示客服列表供用户选择；否则会通知所有客服等待接入。如果客服正在服务中，会自动加入排队。 | 用户 |
| `/转人机`     | 用户取消转人工请求或客服选择，结束等待状态。也可以退出排队。     | 用户 |
| `/取消排队`   | 用户主动退出排队队列。 | 用户 |
| `/排队状态`   | 查看当前在队列中的位置和排队人数。 | 用户 |
| `/接入对话`   | 客服接入用户的对话，开始人工服务。通过回复用户的请求消息使用此命令。 | 客服 |
| `/拒绝接入`   | 客服拒绝用户的接入请求。通过回复用户的请求消息使用此命令。 | 客服 |
| `/导出记录`   | 导出当前会话的聊天记录（需启用聊天记录功能）。以QQ聊天记录格式发送。 | 客服 |
| `/结束对话`   | 客服结束当前对话，关闭会话。如果队列中有等待的用户，会自动准备接入下一位。 | 客服 |

### 配置说明

插件支持以下配置项（在插件配置页面设置）：

#### 基础配置

1. **客服QQ号列表** (`servicers_id`)
   - 类型：列表
   - 格式：`["123456789", "987654321", "555666777"]`
   - 说明：填写客服的QQ号列表
   - 如果不填，默认使用全局配置中的管理员作为客服

1.1. **客服名称列表** (`servicers_names`) - 可选 ⭐
   - 类型：列表
   - 格式：`["客服小王", "客服小李", "客服小张"]`
   - 说明：填写客服的名称，顺序对应 `servicers_id`。用户可以看到客服名称
   - 如果不填或数量不够，对应的客服将显示QQ号
   - 示例：如果 `servicers_id` 是 `["123456789", "987654321"]`，则 `servicers_names` 是 `["客服小王", "客服小李"]`

2. **启用客服选择功能** (`enable_servicer_selection`)
   - 类型：布尔值（true/false）
   - 默认：true
   - 说明：当有多个客服时，是否让用户选择对接哪个客服

3. **启用聊天记录功能** (`enable_chat_history`)
   - 类型：布尔值（true/false）
   - 默认：false
   - 说明：开启后，客服可以使用 `/导出记录` 命令导出当前会话的聊天记录

#### ⏰ 时间限制配置（v1.5.0新增）

4. **对话时间限制** (`conversation_timeout`)
   - 类型：整数（秒）
   - 默认：0（不限制）
   - 说明：单次对话的最大时长。设置为0表示不限制。超时后会自动结束对话并接入下一位
   - 示例：设置为1800表示每次对话最多1800秒（30分钟）

5. **排队时间限制** (`queue_timeout`)
   - 类型：整数（秒）
   - 默认：0（不限制）
   - 说明：用户最大排队等待时长。设置为0表示不限制。超时后会自动移出队列并通知用户
   - 示例：设置为900表示最多排队900秒（15分钟）

6. **超时提前提醒** (`timeout_warning_seconds`)
   - 类型：整数（秒）
   - 默认：120
   - 说明：在对话即将超时前多少秒提醒。设置为0表示不提醒。仅在设置了对话时间限制时有效
   - 示例：设置为180表示对话结束前180秒（3分钟）会提醒用户和客服

### 使用流程

#### 单客服模式
1. 用户发送 `/转人工`
2. 系统检查客服状态：
   - 如果客服空闲：通知客服有用户请求
   - 如果客服忙碌：将用户加入排队队列，显示排队位置
3. 客服使用 `/接入对话` 接入
4. 开始双向消息转发
5. 客服使用 `/结束对话` 结束会话
6. 如果队列中有等待用户，系统自动准备接入下一位

#### 多客服选择模式
1. 用户发送 `/转人工`
2. 系统显示客服列表（包含客服状态：空闲🟢/忙碌🔴，以及排队人数）
3. 用户回复序号选择客服
4. 系统检查客服状态：
   - 如果客服空闲：通知客服有用户请求
   - 如果客服忙碌：将用户加入该客服的排队队列
5. 客服使用 `/接入对话` 接入
6. 开始双向消息转发
7. 客服使用 `/结束对话` 结束会话
8. 如果队列中有等待用户，系统自动准备接入下一位

#### 队列管理
- 用户可以使用 `/排队状态` 查看当前排队位置
- 用户可以使用 `/取消排队` 或 `/转人机` 退出队列
- 客服结束对话后，队列中的下一位用户会自动准备接入
- 客服会收到队列状态提示

#### ⏰ 时间限制（可选功能）
- **对话开始时**：如果配置了对话时间限制，用户和客服都会收到时间提示
- **对话进行中**：系统自动检查时间，临近超时时会提前提醒
- **对话超时**：自动结束对话，通知双方，并自动接入队列中的下一位用户
- **排队超时**：超过排队时间限制的用户会自动移出队列并收到通知

**注意**：
- 用户在任何阶段都可以使用 `/转人机` 或 `/取消排队` 取消请求
- 时间限制功能是可选的，默认不限制（配置为0）
- 建议根据实际客服工作负载合理设置时间限制

### 示例图

![c4c33c6e4ea7687165880e0c55eacd2](https://github.com/user-attachments/assets/4024faae-3932-4c63-9ceb-b72f785fbb03)

## 👥 贡献指南

- 🌟 Star 这个项目！（点右上角的星星，感谢支持！）
- 🐛 提交 Issue 报告问题
- 💡 提出新功能建议
- 🔧 提交 Pull Request 改进代码

## 📌 注意事项

- 想第一时间得到反馈的可以来作者的插件反馈群（QQ群）：460973561（不点star不给进）
